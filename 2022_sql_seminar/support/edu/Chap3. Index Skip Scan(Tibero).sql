#####################################################################################################
▶ Index Skip Scan을 이용한 I/O 비효율 해소
#####################################################################################################

2008년 1월~12월까지 월별로 10만개(총 120만개) 판매 데이터
판매구분은 'A'가 10만개, 'B'가 110만개
  
create table cust_sales
as
select rownum                                      cust_id
     , '2021' || lpad(ceil(rownum/100000), 2, '0') month
     , decode(mod(rownum, 12), 1, 'A', 'B')        idx
     , round(dbms_random.value(1000,100000), -2)   amount
  from dual
connect by level <= 1200000 ;

exec dbms_stats.gather_table_stats(user, 'CUST_SALES');

[Case 1 - Full Scan]
select /*+ full(t) */ count(*)
  from cust_sales t
 where idx = 'A'
   and month between '202101' and '202112';
   
--------------------------------------------------------------------------------------------
| ID  | Operation              | Name       | Rows    | Elaps. Time  | CR Gets  | Starts   |
--------------------------------------------------------------------------------------------
|   1 | COLUMN PROJECTION      |            |       1 |00:00:00.0000 |       0  |       1  |
|   2 |  SORT AGGR             |            |       1 |00:00:00.0000 |       0  |       1  |
|   3 |   TABLE ACCESS (FULL)  | CUST_SALES |       0 |00:00:00.0840 |    3812  |       1  |
--------------------------------------------------------------------------------------------
 
Predicate Information
----------------------------------------------------------------------------------------------------------------------------------------------------------
    3 - filter: ("T"."MONTH" >= '200801') AND ("T"."MONTH" <= '200812') AND ("T"."IDX" = 'A') (0.042 * 0.042 * 0.082)

★★★ create index cust_sales_idx1 on cust_sales(idx, month); ★★★
[Case 2-1]
select /*+ index(t(idx, month)) */ count(*)
  from cust_sales t
 where idx = 'A'
   and month between '202101' and '202112';

------------------------------------------------------------------------------------------------
| ID  | Operation             | Name            | Rows    | Elaps. Time  | CR Gets  | Starts   |
------------------------------------------------------------------------------------------------
|   1 | COLUMN PROJECTION     |                 |       1 |00:00:00.0000 |       0  |       1  |
|   2 |  SORT AGGR            |                 |       1 |00:00:00.0025 |       0  |       1  |
|   3 |   INDEX (RANGE SCAN)  | CUST_SALES_IDX1 |  100000 |00:00:00.0209 |     287  |       1  |
------------------------------------------------------------------------------------------------
 
Predicate Information
--------------------------------------------------------------------------------------------------------------------------------------------------------------
    3 - access: ("T"."IDX" = 'A') AND ("T"."MONTH" >= '202101') AND ("T"."MONTH" <= '202112') (0.082 * 0.042 * 1.000)

▶ 287개의 블럭 I/O 발생, 테이블 액세스는 발생하지 않음

[Case 2-2]
select /*+ index(t(idx, month)) */ count(*)
  from cust_sales t
 where idx = 'A'
   and month in ('202101', '202102', '202103', '202104', '202105', '202106'
                ,'202107', '202108', '202109', '202110', '202111', '202112' ) ;

-------------------------------------------------------------------------------------------------
| ID  | Operation              | Name            | Rows    | Elaps. Time  | CR Gets  | Starts   |
-------------------------------------------------------------------------------------------------
|   1 | COLUMN PROJECTION      |                 |       1 |00:00:00.0000 |       0  |       1  |
|   2 |  SORT AGGR             |                 |       1 |00:00:00.0024 |       0  |       1  |
|   3 |   INLIST ITERATOR      |                 |  100000 |00:00:00.0000 |       0  |       1  |
|   4 |    INDEX (RANGE SCAN)  | CUST_SALES_IDX1 |  100000 |00:00:00.0220 |     353  |      12  |
-------------------------------------------------------------------------------------------------
 
Predicate Information
---------------------------------------------------------------------------------------------------------------------------------------------------------------
    4 - access: ("T"."IDX" = 'A') AND ("T"."MONTH" = :0) (0.082 * 1.000)

★★★ create index cust_sales_idx2 on cust_sales(month, idx); ★★★
[Case 3-1]
select /*+ no_index_ss(t(month, idx)) index(t(month, idx)) */ count(*)
  from cust_sales t
 where idx = 'A'
   and month between '202101' and '202112';

-------------------------------------------------------------------------------------------------
| ID  | Operation              | Name            | Rows    | Elaps. Time  | CR Gets  | Starts   |
-------------------------------------------------------------------------------------------------
|   1 | COLUMN PROJECTION      |                 |       1 |00:00:00.0000 |       0  |       1  |
|   2 |  SORT AGGR             |                 |       1 |00:00:00.0020 |       0  |       1  |
|   3 |   FILTER               |                 |  100000 |00:00:00.0381 |       0  |       1  |
|   4 |    INDEX (RANGE SCAN)  | CUST_SALES_IDX2 | 1108333 |00:00:00.0220 |    3128  |       1  |
-------------------------------------------------------------------------------------------------
 
Predicate Information
---------------------------------------------------------------------------------------------------------------------------------------------------------------
    3 - filter: ("T"."IDX" = 'A') (0.082)
    4 - access: ("T"."MONTH" >= '202101') AND ("T"."IDX" = 'A') AND ("T"."MONTH" <= '202112') (0.042 * 0.082 * 1.000)

[Case 3-2]
select /*+ no_index_ss(t(month, idx)) index(t(month, idx)) */ count(*)
  from cust_sales t
 where idx = 'A'
   and month in ('202101', '202102', '202103', '202104', '202105', '202106'
                ,'202107', '202108', '202109', '202110', '202111', '202112' ) ;

-------------------------------------------------------------------------------------------------
| ID  | Operation              | Name            | Rows    | Elaps. Time  | CR Gets  | Starts   |
-------------------------------------------------------------------------------------------------
|   1 | COLUMN PROJECTION      |                 |       1 |00:00:00.0000 |       0  |       1  |
|   2 |  SORT AGGR             |                 |       1 |00:00:00.0025 |       0  |       1  |
|   3 |   INLIST ITERATOR      |                 |  100000 |00:00:00.0000 |       0  |       1  |
|   4 |    INDEX (RANGE SCAN)  | CUST_SALES_IDX2 |  100000 |00:00:00.0031 |     353  |      12  |
-------------------------------------------------------------------------------------------------
 
Predicate Information
---------------------------------------------------------------------------------------------------------------------------------------------------------------
    4 - access: ("T"."MONTH" = :0) AND ("T"."IDX" = 'A') (1.000 * 0.082)

[Case 4-1]
select /*+ index_ss(t(idx, month)) */ count(*)
  from cust_sales t
 where idx like 'A%'  -- Tibero 버그로 생각됨
   and month between '202101' and '202112';

------------------------------------------------------------------------------------------------
| ID  | Operation             | Name            | Rows    | Elaps. Time  | CR Gets  | Starts   |
------------------------------------------------------------------------------------------------
|   1 | COLUMN PROJECTION     |                 |       1 |00:00:00.0000 |       0  |       1  |
|   2 |  SORT AGGR            |                 |       1 |00:00:00.0024 |       0  |       1  |
|   3 |   FILTER              |                 |  100000 |00:00:00.1329 |       0  |       1  |
|   4 |    INDEX (SKIP SCAN)  | CUST_SALES_IDX1 | 1200000 |00:00:00.1638 |    3392  |       1  |
------------------------------------------------------------------------------------------------
 
Predicate Information
--------------------------------------------------------------------------------------------------------------------------------------------------------------
    3 - filter: ("T"."IDX" LIKE 'A%') (0.000)
    4 - access: ("T"."MONTH" >= '202101') AND ("T"."MONTH" <= '202112') (0.042 * 1.000)

[Case 4-2]
select /*+ index_ss(t(month, idx)) */ count(*)
  from cust_sales t
 where idx = 'A'
   and month in ('202101', '202102', '202103', '202104', '202105', '202106'
                ,'202107', '202108', '202109', '202110', '202111', '202112' ) ;

------------------------------------------------------------------------------------------------
| ID  | Operation             | Name            | Rows    | Elaps. Time  | CR Gets  | Starts   |
------------------------------------------------------------------------------------------------
|   1 | COLUMN PROJECTION     |                 |       1 |00:00:00.0000 |       0  |       1  |
|   2 |  SORT AGGR            |                 |       1 |00:00:00.0025 |       0  |       1  |
|   3 |   FILTER              |                 |  100000 |00:00:00.0179 |       0  |       1  |
|   4 |    INDEX (SKIP SCAN)  | CUST_SALES_IDX2 |  100000 |00:00:00.0033 |     341  |       1  |
------------------------------------------------------------------------------------------------
 
Predicate Information
--------------------------------------------------------------------------------------------------------------------------------------------------------------
    3 - filter: (("T"."MONTH") IN (('202101'),('202102'),('202103'),('202104'),('202105'),('202106'),('202107'),('202108'),('202109'),('202110'),('202111'),('202112'))) (0.648)
    4 - access: ("T"."IDX" = 'A') (0.082)
